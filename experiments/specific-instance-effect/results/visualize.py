from pathlib import Path
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
import numpy as np

def visualize_hayes_roth_results():
    """
    Visualizes the Hayes-Roth Specific Instance Effect using the generated CSV.
    
    Items of interest (Club 1):
    1. Frequent Exemplar (e.g. 112, Dist 1, Freq 10)
    2. Rare Exemplar (e.g. 113, Dist 1, Freq 1)
    3. Prototype (111, Dist 0, Freq 0)
    
    Effect:
    - Recognition: Freq > Prototype (Specific Instance Effect)
    - Classification: Prototype >= Freq (Prototype Enhancement) or Freq > Rare
    """
    root_dir = Path(__file__).resolve().parent
    csv_path = root_dir / "exp_specific_instance_discrete.csv"
    
    if not csv_path.exists():
        print(f"Error: CSV not found at {csv_path}")
        return
        
    df = pd.read_csv(csv_path)
    
    # Filter for the relevant tags generated by the experiment script
    target_tags = ["Freq_Exemplar", "Prototype", "Rare_Exemplar"]
    subset = df[df["tag"].isin(target_tags)].copy()
    
    # Map Tags to Display Names
    name_map = {
        "Freq_Exemplar": "Frequent Exemplar\n(Freq=10)",
        "Prototype": "Prototype\n(Freq=0)",
        "Rare_Exemplar": "Rare Exemplar\n(Freq=1)"
    }
    subset["Item Type"] = subset["tag"].map(name_map)
    
    # Define Plot Order
    plot_order = [
         "Frequent Exemplar\n(Freq=10)",
         "Rare Exemplar\n(Freq=1)",
         "Prototype\n(Freq=0)"
    ]
    
    # Calculate Means and Standard Errors
    # We aggregate by Item Type first (averaging over items and seeds)
    summary = subset.groupby(["Item Type"], as_index=False).agg(
        recog_mean=("recog_score", "mean"),
        recog_std=("recog_score", "std"),
        class_mean=("p_club1", "mean"),
        class_std=("p_club1", "std"),
        count=("seed", "count")
    )
    
    # Compute SEM approx (std / sqrt(count))
    summary["recog_sem"] = summary["recog_std"] / np.sqrt(summary["count"])
    summary["class_sem"] = summary["class_std"] / np.sqrt(summary["count"])
    
    sns.set_theme(style="whitegrid")
    
    # -------------------------------------------------------
    # Plot 1: Classification Probability (of Club 1)
    # -------------------------------------------------------
    fig1, ax1 = plt.subplots(figsize=(8, 6))
    
    # Reindex to force order
    summ_ordered = summary.set_index("Item Type").reindex(plot_order)
    
    # Bars: White, White (Hatched), Black
    bars = ax1.bar(plot_order, summ_ordered["class_mean"], 
                   yerr=summ_ordered["class_sem"], capsize=5,
                   color=["white", "white", "black"], 
                   edgecolor="black", linewidth=1.5)
    
    # Hatching for Rare (Index 1)
    bars[1].set_hatch('///')
    
    ax1.set_title("Hayes-Roth (1977): Classification Probabilities", fontsize=15, pad=15)
    ax1.set_ylabel("Probability of 'Club 1' Response", fontsize=12)
    ax1.set_xlabel("")
    ax1.set_ylim(0, 1.1) # Probabilities are 0-1
    
    # Add Value Labels
    for rect in bars:
        height = rect.get_height()
        ax1.text(rect.get_x() + rect.get_width()/2., height + 0.02,
                f'{height:.2f}', ha='center', va='bottom', fontsize=11, fontweight='bold')

    plt.tight_layout()
    plt.savefig(root_dir / "hayes_roth_classification.png", dpi=300)
    print(f"Saved classification plot to {root_dir}/hayes_roth_classification.png")

    # -------------------------------------------------------
    # Plot 2: Recognition (Log Likelihood)
    # -------------------------------------------------------
    fig2, ax2 = plt.subplots(figsize=(8, 6))
    
    # Bars
    bars2 = ax2.bar(plot_order, summ_ordered["recog_mean"], 
                    yerr=summ_ordered["recog_sem"], capsize=5,
                   color=["white", "white", "black"], 
                   edgecolor="black", linewidth=1.5)
    
    # Hatching for Rare
    bars2[1].set_hatch('///')
    
    ax2.set_title("Hayes-Roth (1977): Recognition Confidence", fontsize=15, pad=15)
    ax2.set_ylabel("Recognition Confidence (Log Likelihood)", fontsize=12)
    ax2.set_xlabel("")
    
    # Add Value Labels
    # Handle negative bars (labels below)
    for rect in bars2:
        height = rect.get_height()
        offset = abs(height) * 0.05 if height != 0 else 0.5
        if height < 0:
            y_pos = height - offset
            va = 'top'
        else:
            y_pos = height + offset
            va = 'bottom'
        ax2.text(rect.get_x() + rect.get_width()/2., y_pos,
                f'{height:.2f}', ha='center', va=va, fontsize=11, fontweight='bold')
        
    # Adjust Y-limits for negative values
    min_val = summ_ordered["recog_mean"].min()
    if min_val < 0:
        ax2.set_ylim(bottom=min_val * 1.2) # Pad below
        
    plt.tight_layout()
    plt.savefig(root_dir / "hayes_roth_recognition.png", dpi=300)
    print(f"Saved recognition plot to {root_dir}/hayes_roth_recognition.png")

if __name__ == "__main__":
    visualize_hayes_roth_results()
